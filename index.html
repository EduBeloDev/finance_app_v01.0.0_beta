<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador Financeiro Casal Completo</title>
    <style>
        :root {
            --primary: #2b79ec;
            --primary-dark: #1e5bb8;
            --secondary: #64748b;
            --success: #16a34a;
            --danger: #dc2626;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 50px;
        }

        /* HEADER & TABS */
        header {
            background: var(--primary);
            color: white;
            padding: 20px 20px 0 20px;
            text-align: center;
        }
        
        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }

        .tab-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            flex: 1;
            max-width: 200px;
        }

        .tab-btn:hover { background: rgba(255,255,255,0.3); }
        .tab-btn.active { background: var(--card); color: var(--primary); }

        .tab-content { display: none; padding: 30px; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* FORMUL√ÅRIOS */
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; }
        
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #475569; }
        
        input, select, button.action-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(43, 121, 236, 0.15);
        }

        /* BOT√ïES DE A√á√ÉO */
        .btn-action {
            width: 100%;
            padding: 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: 0.2s;
        }
        .btn-action:hover { background-color: var(--primary-dark); }

        /* CALEND√ÅRIO POP-UP */
        .calendar-wrapper { position: relative; }
        .btn-toggle-cal {
            background: #fff;
            border: 1px dashed #94a3b8;
            color: var(--primary);
            font-weight: bold;
            cursor: pointer;
            text-align: left;
        }
        .calendar-popup {
            display: none;
            position: absolute;
            top: 100%; left: 0;
            z-index: 50;
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 8px;
            width: 280px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .day-cell {
            padding: 8px 0;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            background: #f1f5f9;
        }
        .day-cell:hover { background: #e2e8f0; }
        .day-cell.selected { background: var(--primary); color: white; }

        .inputs-dinamicos {
            margin-top: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        /* TIMELINE HORIZONTAL */
        .timeline-wrapper {
            margin-top: 40px;
            border-top: 2px dashed #cbd5e1;
            padding-top: 20px;
        }
        
        /* GR√ÅFICO */
        .chart-container {
            width: 100%;
            height: 150px;
            background: #fff;
            margin-bottom: 10px;
            position: relative;
        }
        canvas { width: 100%; height: 100%; }

        .timeline-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 20px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) #e2e8f0;
        }
        
        .day-card {
            min-width: 150px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
            flex-shrink: 0;
            position: relative;
            transition: 0.2s;
        }
        .day-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .day-card.today { border: 2px solid var(--primary); background: #eff6ff; }
        
        .dc-header { font-weight: bold; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; margin-bottom: 5px; display:flex; justify-content:space-between;}
        .dc-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 3px; }
        .val-editable { cursor: pointer; border-bottom: 1px dotted #94a3b8; }
        .val-editable:hover { background: #fffae0; color: #000 !important; }
        
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-blue { color: var(--primary); font-weight: bold; }

        /* AREA DE RESULTADOS */
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Duas colunas */
            gap: 20px;
            margin-top: 20px;
        }

        .result-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; display:flex; flex-direction:column; justify-content:center; }
        .summary-card { background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 12px; padding: 15px; text-align: left; font-size: 0.9rem; }
        
        .big-value { font-size: 2rem; font-weight: 800; color: var(--success); }
        
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 2px;}
        .summary-label { color: #64748b; font-weight: 500; }
        .summary-val { font-weight: 700; color: #334155; }

        /* ESTILOS ESPEC√çFICOS PARA ANUAL/METAS */
        .grid-anual { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card-info { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 10px; }
        .card-info h3 { margin: 0 0 10px 0; color: var(--success); }
        .info-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #cbd5e1; padding: 5px 0; font-size: 0.9rem; }
        
        .details-loan { text-align: left; background: white; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #d1d5db; }
        .loan-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .loan-highlight { color: var(--danger); font-weight: bold; }

        /* TOAST NOTIFICATION (POP UP) */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            top: 30px;
            transform: translateX(-50%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 1rem;
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 10px;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        #toast.success { background-color: var(--success); }

        @keyframes fadein {
            from {top: 0; opacity: 0;}
            to {top: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {top: 30px; opacity: 1;}
            to {top: 0; opacity: 0;}
        }

        /* Modal Overlay */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; }
        .close-modal { background: #e2e8f0; color: #475569; border: none; padding: 10px 20px; border-radius: 6px; margin-top: 20px; cursor: pointer; font-weight: bold; }

        @media (max-width: 600px) { 
            .row, .grid-anual { flex-direction: column; grid-template-columns: 1fr; } 
            .results-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="toast">‚úÖ Despesa adicionada √† linha do tempo!</div>

<div class="container">
    <header>
        <h1>üí∞ Gest√£o Financeira Inteligente</h1>
        <div class="tab-nav">
            <button class="tab-btn active" onclick="openTab('mensal')">Or√ßamento Mensal</button>
            <button class="tab-btn" onclick="openTab('anual')">An√°lise Anual</button>
            <button class="tab-btn" onclick="openTab('metas')">Metas</button>
        </div>
    </header>

    <div id="mensal" class="tab-content active">
        
        <div class="row">
            <div class="col">
                <label>M√™s de Refer√™ncia</label>
                <input type="month" id="mesRef" onchange="initMensal()">
            </div>
            <div class="col" style="display:flex; align-items:end; padding-bottom:12px; font-weight:bold; color:var(--secondary);">
                <span id="labelDiasMes"></span>
            </div>
        </div>

        <div class="row" style="background: #eff6ff; padding: 15px; border-radius: 8px; border: 1px solid #bfdbfe; margin-top: 20px;">
            <div class="col">
                <label style="color: #1e40af;">üí∞ Algum valor restante do m√™s anterior?</label>
                <input type="text" id="saldo_anterior" placeholder="R$ 0,00" onkeyup="mascaraMoeda(this); updateCalculos()">
            </div>
        </div>

        <h3 style="color:var(--success); border-bottom:1px solid #e2e8f0; margin-top:30px;">üíµ Entradas (Sal√°rios)</h3>
        
        <div class="row">
            <div class="col calendar-wrapper">
                <label>üë§ Seus Recebimentos</label>
                <button class="btn-toggle-cal" onclick="toggleCalendar('cal_user1')">üìÖ Selecionar Dias (M√°x 2)</button>
                
                <div id="cal_user1" class="calendar-popup">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>Selecione at√© 2 dias:</span>
                        <span style="cursor:pointer; color:red;" onclick="toggleCalendar('cal_user1')">‚úñ</span>
                    </div>
                    <div class="calendar-grid" id="grid_user1"></div>
                    <button style="width:100%; margin-top:10px; padding:5px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer;" onclick="toggleCalendar('cal_user1')">Fechar</button>
                </div>
                
                <div id="inputs_user1" class="inputs-dinamicos" style="display:none;"></div>
            </div>

            <div class="col calendar-wrapper">
                <label>üë§ Recebimentos C√¥njuge</label>
                <button class="btn-toggle-cal" onclick="toggleCalendar('cal_user2')">üìÖ Selecionar Dias (M√°x 2)</button>
                
                <div id="cal_user2" class="calendar-popup">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>Selecione at√© 2 dias:</span>
                        <span style="cursor:pointer; color:red;" onclick="toggleCalendar('cal_user2')">‚úñ</span>
                    </div>
                    <div class="calendar-grid" id="grid_user2"></div>
                    <button style="width:100%; margin-top:10px; padding:5px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer;" onclick="toggleCalendar('cal_user2')">Fechar</button>
                </div>
                
                <div id="inputs_user2" class="inputs-dinamicos" style="display:none;"></div>
            </div>
        </div>

        <h3 style="color:var(--danger); border-bottom:1px solid #e2e8f0; margin-top:30px;">üìâ Adicionar Despesa Pontual</h3>
        <div class="row" style="background: #fff1f2; padding: 15px; border-radius: 8px; border: 1px solid #fecdd3;">
            <div class="col">
                <label>Valor da Despesa</label>
                <input type="text" id="add_valor_despesa" placeholder="R$ 0,00" onkeyup="mascaraMoeda(this)">
            </div>
            <div class="col">
                <label>Dia do Vencimento</label>
                <input type="number" id="add_dia_despesa" min="1" max="31" placeholder="Dia">
            </div>
            <div class="col" style="display:flex; align-items:end;">
                <button class="action-btn" style="background:var(--danger); color:white; border:none; cursor:pointer; font-weight:bold;" onclick="adicionarDespesa()">‚¨á Lan√ßar Despesa</button>
            </div>
        </div>
        <p style="font-size:0.8rem; color:#64748b;">* Insira o valor total de gastos para o dia selecionado. O valor ser√° somado ao dia.</p>

        <div class="row">
             <div class="col">
                <label>üè¶ Meta Economia (Mensal)</label>
                <input type="text" id="m_meta" placeholder="R$ 0,00" onkeyup="mascaraMoeda(this); updateCalculos()">
            </div>
        </div>

        <div class="timeline-wrapper" id="timelineSection" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>üìä Fluxo do M√™s (Gr√°fico & Timeline)</h3>
                <small style="color:var(--secondary)">Clique nos valores na linha do tempo para editar</small>
            </div>
            
            <div class="chart-container">
                <canvas id="financeChart"></canvas>
            </div>

            <div class="timeline-scroll" id="timelineScroll">
                </div>
            
            <div class="results-container">
                <div class="result-card">
                    <label>SALDO FINAL PREVISTO</label>
                    <div id="saldoFinal" class="big-value">R$ 0,00</div>
                    <span style="font-size:0.8rem; color:#64748b;">(Ap√≥s abater metas e despesas)</span>
                </div>

                <div class="summary-card">
                    <h4 style="margin:0 0 10px 0; color:var(--primary);">üìã Resumo Calculado:</h4>
                    
                    <div class="summary-row">
                        <span class="summary-label">Total Ganhos:</span>
                        <span class="summary-val text-green" id="res_total_ganhos">R$ 0,00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Gastos + Meta:</span>
                        <span class="summary-val text-red" id="res_total_gastos">R$ 0,00</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Gasto Di√°rio (Livre):</span>
                        <span class="summary-val text-blue" id="res_gasto_diario">R$ 0,00 /dia</span>
                    </div>
                    <div style="margin-top:10px; font-weight:bold; display:flex; justify-content:space-between;">
                        <span>Resultado:</span>
                        <span id="res_situacao">---</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="anual" class="tab-content">
        <h2>üìä An√°lise Anual & Impostos</h2>
        <p style="font-size:0.9rem; color:#64748b; margin-bottom:20px;">Insira os valores brutos para um c√°lculo mais preciso de CLT e Imposto de Renda.</p>

        <div class="row">
            <div class="col">
                <label>Seu Sal√°rio (Base C√°lculo)</label>
                <input type="text" id="a_salario1" placeholder="R$ 0,00" onkeyup="mascaraMoeda(this)">
            </div>
            <div class="col">
                <label>Sal√°rio Esposa/o (Base C√°lculo)</label>
                <input type="text" id="a_salario2" placeholder="R$ 0,00" onkeyup="mascaraMoeda(this)">
            </div>
        </div>

        <button class="btn-action" onclick="calcAnual()">GERAR PROJE√á√ÉO ANUAL</button>

        <div class="grid-anual" id="resultadoAnual" style="display:none; animation:fadeIn 0.5s;">
            <div class="card-info">
                <h3>üë§ Voc√™ (Estimativa CLT)</h3>
                <div class="info-line"><span>13¬∫ Sal√°rio:</span> <strong id="res_13_1">R$ 0</strong></div>
                <div class="info-line"><span>F√©rias (1/3):</span> <strong id="res_ferias_1">R$ 0</strong></div>
                <div class="info-line"><span>FGTS Acumulado:</span> <strong id="res_fgts_1">R$ 0</strong></div>
            </div>
            <div class="card-info">
                <h3>üë§ Esposa/o (Estimativa CLT)</h3>
                <div class="info-line"><span>13¬∫ Sal√°rio:</span> <strong id="res_13_2">R$ 0</strong></div>
                <div class="info-line"><span>F√©rias (1/3):</span> <strong id="res_ferias_2">R$ 0</strong></div>
                <div class="info-line"><span>FGTS Acumulado:</span> <strong id="res_fgts_2">R$ 0</strong></div>
            </div>
        </div>
    </div>

    <div id="metas" class="tab-content">
        <h2>‚úàÔ∏è Planejamento de Metas</h2>
        
        <div class="row">
            <div class="col">
                <label>Qual seu objetivo?</label>
                <select id="p_tipo" onchange="verificarTipoMeta()">
                    <option value="viagem">‚úàÔ∏è Viagem</option>
                    <option value="estudos">üìö Estudos</option>
                    <option value="investimento">üìà Investimentos</option>
                    <option value="emergencia">üÜò Reserva de Emerg√™ncia</option>
                    <option value="emprestimo">üí∞ Empr√©stimo</option>
                    <option value="outro">üéØ Outro</option>
                </select>
            </div>
        </div>

        <div class="row" id="row_meta_padrao">
            <div class="col">
                <label>Valor da Meta</label>
                <input type="text" id="p_meta" onkeyup="mascaraMoeda(this)">
            </div>
        </div>

        <div class="row" id="row_meta_emprestimo" style="display: none;">
            <div class="col">
                <label>Qual o valor?</label>
                <input type="text" id="p_valor_emp" placeholder="Valor do empr√©stimo" onkeyup="mascaraMoeda(this)">
            </div>
            <div class="col">
                <label>Qual a porcentagem de % (a.m)?</label>
                <input type="number" id="p_juros" placeholder="Ex: 1.5">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>Parcelar em:</label>
                <select id="p_prazo">
                    <option value="12">12 meses (1 ano)</option>
                    <option value="24">24 meses (2 anos)</option>
                    <option value="48">48 meses (4 anos)</option>
                    <option value="64">64 meses</option>
                    <option value="120">120 meses (10 anos)</option>
                    <option value="240">240 meses (20 anos)</option>
                </select>
            </div>
        </div>
        
        <button class="btn-action" onclick="calcMetas()">CALCULAR</button>

        <div id="resMetaSucesso" class="result-card" style="display:none; background:#f0fdf4; border-color:#bbf7d0;">
            <label style="color:var(--success)" id="labelMetaResultado">‚úÖ RESULTADO:</label>
            
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <div class="big-value" id="p_resultado_final" style="margin: 5px 0;">R$ 0,00</div>
                <span id="p_juros_parcela_info" style="font-size: 0.9rem; color: var(--danger); font-weight: 500;"></span>
            </div>
            
            <p id="p_texto_resultado">Valor mensal.</p>

            <div id="p_detalhes_emp" class="details-loan" style="display: none;">
                <div class="loan-row" style="border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; margin-bottom: 10px;">
                    <strong>Resumo do Empr√©stimo:</strong>
                </div>
                <div class="loan-row">
                    <span>Valor Final (Total a Pagar):</span>
                    <strong id="p_total_final">R$ 0,00</strong>
                </div>
                <div class="loan-row">
                    <span>Total de Juros Pagos:</span>
                    <strong class="loan-highlight" id="p_total_juros">R$ 0,00</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalIR" class="modal-overlay">
    <div class="modal-box">
        <div style="font-size:3rem;">ü¶Å</div>
        <h2 style="color:var(--danger); border:none;">Alerta do Le√£o!</h2>
        <div id="txtIR" style="text-align:left; background:#fef2f2; padding:15px; border-radius:8px; margin:15px 0;"></div>
        <p style="font-size:0.8rem; color:#64748b;">Baseado na tabela IR 2024/2025. Consulte um contador.</p>
        <button class="close-modal" onclick="fecharModal('modalIR')">Entendi</button>
    </div>
</div>

<script>
    // --- ESTADO DA APLICA√á√ÉO ---
    let dadosMensais = {};
    let config = {
        diasUser1: [],
        diasUser2: []
    };
    
    // --- INICIALIZA√á√ÉO ---
    window.onload = function() {
        const hoje = new Date();
        document.getElementById('mesRef').value = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
        initMensal();
    }

    function initMensal() {
        dadosMensais = {};
        const mesInput = document.getElementById('mesRef').value;
        if(!mesInput) return;
        
        const [ano, mes] = mesInput.split('-').map(Number);
        const diasNoMes = new Date(ano, mes, 0).getDate();
        
        document.getElementById('labelDiasMes').innerText = `M√™s de ${diasNoMes} dias`;

        // Inicializa array de dados zerados
        for(let i=1; i<=diasNoMes; i++) {
            dadosMensais[i] = { u1: 0, u2: 0, desp: 0 };
        }

        renderGridCalendar('user1', diasNoMes);
        renderGridCalendar('user2', diasNoMes);
        
        // Reseta visualiza√ß√µes mas mantem estado limpo
        config.diasUser1 = [];
        config.diasUser2 = [];
        document.getElementById('inputs_user1').innerHTML = '';
        document.getElementById('inputs_user2').innerHTML = '';
        document.getElementById('inputs_user1').style.display = 'none';
        document.getElementById('inputs_user2').style.display = 'none';

        updateCalculos();
    }

    // --- L√ìGICA DE CALEND√ÅRIOS POP-UP ---
    function toggleCalendar(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function renderGridCalendar(userType, diasTotal) {
        const grid = document.getElementById(`grid_${userType}`);
        grid.innerHTML = '';
        
        for (let i = 1; i <= diasTotal; i++) {
            const d = document.createElement('div');
            d.className = 'day-cell';
            d.innerText = i;
            d.onclick = () => selectDay(userType, i, d);
            d.id = `btn_${userType}_${i}`;
            grid.appendChild(d);
        }
    }

    function selectDay(userType, dia, btnInfo) {
        const arr = (userType === 'user1') ? config.diasUser1 : config.diasUser2;
        
        // Toggle sele√ß√£o
        if (arr.includes(dia)) {
            const idx = arr.indexOf(dia);
            arr.splice(idx, 1);
            btnInfo.classList.remove('selected');
            removeInput(userType, dia);
        } else {
            if (arr.length >= 2) {
                alert("M√°ximo de 2 dias de pagamento permitidos.");
                return;
            }
            arr.push(dia);
            btnInfo.classList.add('selected');
            createInput(userType, dia);
            
            // FECHAR CALEND√ÅRIO AUTOMATICAMENTE AP√ìS 2 SELE√á√ïES
            if (arr.length === 2) {
                toggleCalendar('cal_' + userType);
            }
        }
        updateCalculos();
    }

    function createInput(userType, dia) {
        const container = document.getElementById(`inputs_${userType}`);
        container.style.display = 'block';
        
        const div = document.createElement('div');
        div.id = `input_group_${userType}_${dia}`;
        div.style.marginBottom = '10px';
        
        const label = (userType === 'user1') ? 'Seu Sal√°rio' : 'Sal√°rio C√¥njuge';
        
        div.innerHTML = `
            <label style="font-size:0.8rem;">Dia ${dia} - ${label}:</label>
            <input type="text" 
                   value="${formatCurrency(dadosMensais[dia][userType === 'user1' ? 'u1' : 'u2'])}"
                   onkeyup="mascaraMoeda(this); updateSalarioData('${userType}', ${dia}, this.value)" 
                   placeholder="R$ 0,00">
        `;
        container.appendChild(div);
    }

    function removeInput(userType, dia) {
        const el = document.getElementById(`input_group_${userType}_${dia}`);
        if(el) el.remove();
        
        // Zera o valor no modelo de dados
        if(userType === 'user1') dadosMensais[dia].u1 = 0;
        else dadosMensais[dia].u2 = 0;

        const container = document.getElementById(`inputs_${userType}`);
        if (container.children.length === 0) container.style.display = 'none';
    }

    function updateSalarioData(userType, dia, valorStr) {
        const val = parseMoney(valorStr);
        if(userType === 'user1') dadosMensais[dia].u1 = val;
        else dadosMensais[dia].u2 = val;
        updateCalculos();
    }

    // --- L√ìGICA DE DESPESAS ---
    function adicionarDespesa() {
        const valStr = document.getElementById('add_valor_despesa').value;
        const diaStr = document.getElementById('add_dia_despesa').value;
        
        const val = parseMoney(valStr);
        const dia = parseInt(diaStr);
        
        if (!dia || dia < 1 || dia > 31 || !dadosMensais[dia]) {
            alert("Dia inv√°lido para este m√™s.");
            return;
        }
        if (val === 0) {
            alert("Digite um valor v√°lido.");
            return;
        }

        dadosMensais[dia].desp += val;
        
        document.getElementById('add_valor_despesa').value = "";
        document.getElementById('add_dia_despesa').value = "";
        
        // MOSTRA POP-UP
        showToast("‚úÖ Despesa adicionada √† linha do tempo!");
        
        updateCalculos();
    }

    function showToast(message) {
        const toast = document.getElementById("toast");
        toast.innerText = message;
        toast.className = "show success";
        setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }

    // --- C√ÅLCULOS MENSAL ---
    function updateCalculos() {
        // Pega os valores gerais
        const meta = parseMoney(document.getElementById('m_meta').value);
        const saldoAnterior = parseMoney(document.getElementById('saldo_anterior').value);
        
        // Inicia o saldo acumulado com o valor restante do m√™s anterior
        let saldoAcumulado = saldoAnterior;
        let saldoFinal = 0;
        
        // Vari√°veis para o resumo detalhado
        let totalEntradas = saldoAnterior;
        let totalSaidas = 0;

        const scrollDiv = document.getElementById('timelineScroll');
        scrollDiv.innerHTML = "";
        document.getElementById('timelineSection').style.display = 'block';

        const labels = [];
        const dataSaldo = [];
        const dataEntrada = [];
        const dataSaida = [];

        // Verifica dias restantes
        const mesInput = document.getElementById('mesRef').value;
        const [anoRef, mesRef] = mesInput.split('-').map(Number);
        const hoje = new Date();
        const ultimoDia = new Date(anoRef, mesRef, 0).getDate();
        let diasRestantes = 1;
        
        if (anoRef === hoje.getFullYear() && mesRef === (hoje.getMonth()+1)) {
            diasRestantes = Math.max(1, ultimoDia - hoje.getDate());
        } else {
            diasRestantes = ultimoDia;
        }

        for (let dia in dadosMensais) {
            const d = dadosMensais[dia];
            const entradaDia = d.u1 + d.u2;
            const saidaDia = d.desp;
            
            totalEntradas += entradaDia;
            totalSaidas += saidaDia;

            saldoAcumulado += (entradaDia - saidaDia);

            labels.push(dia);
            dataSaldo.push(saldoAcumulado);
            dataEntrada.push(entradaDia);
            dataSaida.push(saidaDia);

            // Cria√ß√£o do Card
            const card = document.createElement('div');
            card.className = 'day-card';
            
            if (hoje.getDate() == dia && document.getElementById('mesRef').value.endsWith(String(hoje.getMonth()+1).padStart(2,'0'))) {
                card.classList.add('today');
            }

            const htmlEntrada = entradaDia > 0 ? `<span class="text-green">+ ${formatCurrency(entradaDia)}</span>` : '<span style="color:#cbd5e1">-</span>';
            const htmlSaida = saidaDia > 0 ? `<span class="text-red">- ${formatCurrency(saidaDia)}</span>` : '<span style="color:#cbd5e1">-</span>';
            
            card.innerHTML = `
                <div class="dc-header">
                    <span>Dia ${dia}</span>
                    <span style="font-size:0.7rem; color:#94a3b8">üìÖ</span>
                </div>
                <div class="dc-row">
                    <span>Entrada:</span>
                    <span class="val-editable text-green" onclick="editarValor(${dia}, 'entrada')">${htmlEntrada}</span>
                </div>
                <div class="dc-row">
                    <span>Sa√≠da:</span>
                    <span class="val-editable text-red" onclick="editarValor(${dia}, 'saida')">${htmlSaida}</span>
                </div>
                <div style="margin-top:8px; border-top:1px solid #e2e8f0; padding-top:5px; font-weight:bold; font-size:0.9rem; color:${saldoAcumulado >=0 ? 'var(--primary)' : 'var(--danger)'}">
                    Saldo: ${formatCurrency(saldoAcumulado)}
                </div>
            `;
            scrollDiv.appendChild(card);
            saldoFinal = saldoAcumulado;
        }

        // --- C√ÅLCULOS FINAIS PARA O RESUMO ---
        const totalGastosComMeta = totalSaidas + meta;
        const saldoLiquido = totalEntradas - totalGastosComMeta;
        const tetoDiario = saldoLiquido > 0 ? (saldoLiquido / diasRestantes) : 0;

        // Atualiza Cards
        document.getElementById('saldoFinal').innerText = formatCurrency(saldoLiquido);
        if (saldoLiquido < 0) document.getElementById('saldoFinal').style.color = 'var(--danger)';
        else document.getElementById('saldoFinal').style.color = 'var(--success)';

        // Atualiza Resumo Detalhado
        document.getElementById('res_total_ganhos').innerText = formatCurrency(totalEntradas);
        document.getElementById('res_total_gastos').innerText = formatCurrency(totalGastosComMeta);
        document.getElementById('res_gasto_diario').innerText = `${formatCurrency(tetoDiario)} /dia`;
        
        const elSituacao = document.getElementById('res_situacao');
        if(saldoLiquido >= 0) {
            elSituacao.innerText = "üëç Sobrou!";
            elSituacao.style.color = "var(--success)";
        } else {
            elSituacao.innerText = "üëé Faltou!";
            elSituacao.style.color = "var(--danger)";
        }

        drawChart(labels, dataSaldo, dataEntrada, dataSaida);
    }

    function editarValor(dia, tipo) {
        const atualObj = dadosMensais[dia];
        let valorAtual = 0;
        let msg = "";

        if (tipo === 'entrada') {
            valorAtual = atualObj.u1 + atualObj.u2;
            msg = `Editar Entradas totais do dia ${dia}.\nValor atual: ${formatCurrency(valorAtual)}`;
        } else {
            valorAtual = atualObj.desp;
            msg = `Editar Despesas do dia ${dia}.\nValor atual: ${formatCurrency(valorAtual)}`;
        }

        let novoValStr = prompt(msg, (valorAtual).toFixed(2));
        if (novoValStr !== null) {
            let novoVal = parseMoney(novoValStr);
            if (novoVal > 1000000) novoVal = 1000000;

            if (tipo === 'entrada') {
                dadosMensais[dia].u1 = novoVal;
                dadosMensais[dia].u2 = 0;
                
                // Atualiza inputs visuais se existirem
                const inp1 = document.getElementById(`input_group_user1_${dia}`);
                if(inp1) inp1.querySelector('input').value = formatCurrency(novoVal);
            } else {
                dadosMensais[dia].desp = novoVal;
            }
            updateCalculos();
        }
    }

    function drawChart(labels, saldos, entradas, saidas) {
        const canvas = document.getElementById('financeChart');
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.parentElement.offsetWidth;
        const h = canvas.height = canvas.parentElement.offsetHeight;
        
        ctx.clearRect(0, 0, w, h);
        
        const padding = 20;
        const usableW = w - (padding*2);
        const usableH = h - (padding*2);
        
        const allValues = [...saldos, ...entradas, ...saidas];
        let maxVal = Math.max(...allValues);
        let minVal = Math.min(...allValues);
        if (maxVal === 0 && minVal === 0) { maxVal = 100; } 
        
        const range = maxVal - Math.min(0, minVal);
        const stepX = usableW / (labels.length - 1 || 1);

        const getY = (val) => {
            return h - padding - ( (val - Math.min(0, minVal)) / range * usableH );
        }

        labels.forEach((dia, i) => {
            const x = padding + (i * stepX);
            const wBar = (stepX / 2.5);

            if (entradas[i] > 0) {
                ctx.fillStyle = '#86efac';
                const yTop = getY(entradas[i]);
                const yBase = getY(0);
                ctx.fillRect(x - wBar, yTop, wBar, yBase - yTop);
            }

            if (saidas[i] > 0) {
                ctx.fillStyle = '#fca5a5';
                const yTop = getY(0);
                const hBar = (saidas[i] / range) * usableH;
                ctx.fillRect(x, yTop, wBar, hBar); 
            }
        });

        ctx.beginPath();
        ctx.strokeStyle = '#2b79ec';
        ctx.lineWidth = 2;
        labels.forEach((dia, i) => {
            const x = padding + (i * stepX);
            const y = getY(saldos[i]);
            if (i===0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        ctx.beginPath();
        ctx.strokeStyle = '#94a3b8';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);
        ctx.moveTo(padding, getY(0));
        ctx.lineTo(w - padding, getY(0));
        ctx.stroke();
    }


    // --- FUN√á√ïES DA ABA ANUAL E METAS ---

    function calcAnual() {
        const s1 = parseMoney(document.getElementById('a_salario1').value);
        const s2 = parseMoney(document.getElementById('a_salario2').value);
        
        function getCLT(sal) {
            return {
                decimo: sal,
                ferias: sal + (sal/3),
                fgts: (sal * 13.33) * 0.08
            };
        }

        const d1 = getCLT(s1);
        const d2 = getCLT(s2);

        document.getElementById('res_13_1').innerText = formatCurrency(d1.decimo);
        document.getElementById('res_ferias_1').innerText = formatCurrency(d1.ferias);
        document.getElementById('res_fgts_1').innerText = formatCurrency(d1.fgts);

        document.getElementById('res_13_2').innerText = formatCurrency(d2.decimo);
        document.getElementById('res_ferias_2').innerText = formatCurrency(d2.ferias);
        document.getElementById('res_fgts_2').innerText = formatCurrency(d2.fgts);

        document.getElementById('resultadoAnual').style.display = 'grid';

        const isencao = 2259.20;
        let msg = [];
        
        if(s1 > isencao) msg.push(`üëâ <b>Seu Sal√°rio:</b> Recebe acima de ${formatCurrency(isencao)}. Prov√°vel tributa√ß√£o.`);
        else msg.push(`üëâ <b>Seu Sal√°rio:</b> Faixa de isen√ß√£o.`);

        if(s2 > isencao) msg.push(`üëâ <b>Sal√°rio do C√¥njuge:</b> Recebe acima de ${formatCurrency(isencao)}. Prov√°vel tributa√ß√£o.`);
        else msg.push(`üëâ <b>Sal√°rio do C√¥njuge:</b> Faixa de isen√ß√£o.`);

        document.getElementById('txtIR').innerHTML = msg.join('<br><br>');
        document.getElementById('modalIR').style.display = 'flex';
    }

    function calcMetas() {
        const tipo = document.getElementById('p_tipo').value;
        const meses = parseInt(document.getElementById('p_prazo').value);
        let resultado = 0;
        let label = "";
        
        document.getElementById('p_detalhes_emp').style.display = 'none';
        document.getElementById('p_juros_parcela_info').innerText = "";

        if (tipo === 'emprestimo') {
            const valorEmp = parseMoney(document.getElementById('p_valor_emp').value);
            let taxaJuros = parseFloat(document.getElementById('p_juros').value);

            if (valorEmp === 0) { alert("Informe o valor do empr√©stimo."); return; }
            if (isNaN(taxaJuros)) taxaJuros = 0;

            if (taxaJuros > 0) {
                const i = taxaJuros / 100;
                resultado = valorEmp * ( (i * Math.pow(1+i, meses)) / (Math.pow(1+i, meses) - 1) );
            } else {
                resultado = valorEmp / meses;
            }
            
            const totalFinal = resultado * meses;
            const totalJuros = totalFinal - valorEmp;
            const jurosMedioPorParcela = totalJuros / meses;

            label = "Valor da Parcela:";
            document.getElementById('labelMetaResultado').innerText = `üè¶ SIMULA√á√ÉO DE EMPR√âSTIMO (${meses}x):`;

            document.getElementById('p_detalhes_emp').style.display = 'block';
            document.getElementById('p_total_final').innerText = formatCurrency(totalFinal);
            document.getElementById('p_total_juros').innerText = formatCurrency(totalJuros);
            
            if (taxaJuros > 0) {
                document.getElementById('p_juros_parcela_info').innerText = `(M√©dia de juros na parcela: ${formatCurrency(jurosMedioPorParcela)})`;
            }

        } else {
            const meta = parseMoney(document.getElementById('p_meta').value);
            if (meta === 0) { alert("Informe o valor da meta."); return; }
            
            resultado = meta / meses;
            label = "";
            document.getElementById('labelMetaResultado').innerText = `‚úÖ PLANO PARA ${meses} MESES:`;
        }

        document.getElementById('p_resultado_final').innerText = formatCurrency(resultado) + (tipo !== 'emprestimo' ? " /m√™s" : "");
        document.getElementById('p_texto_resultado').innerText = label;
        document.getElementById('resMetaSucesso').style.display = 'block';
    }

    function verificarTipoMeta() {
        const tipo = document.getElementById('p_tipo').value;
        const divPadrao = document.getElementById('row_meta_padrao');
        const divEmp = document.getElementById('row_meta_emprestimo');

        if (tipo === 'emprestimo') {
            divPadrao.style.display = 'none';
            divEmp.style.display = 'flex';
        } else {
            divPadrao.style.display = 'flex';
            divEmp.style.display = 'none';
        }
        document.getElementById('resMetaSucesso').style.display = 'none';
    }

    // --- UTILS COMPARTILHADAS ---
    function openTab(tabName) {
        const contents = document.getElementsByClassName('tab-content');
        for (let c of contents) c.classList.remove('active');
        const btns = document.getElementsByClassName('tab-btn');
        for (let b of btns) b.classList.remove('active');
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

    function mascaraMoeda(i) {
        let v = i.value.replace(/\D/g,'');
        if (v === "") { i.value = ""; return; }
        let floatVal = parseFloat(v) / 100;
        if(isNaN(floatVal)) floatVal = 0;
        if (floatVal > 1000000) floatVal = 1000000;
        i.value = formatCurrency(floatVal);
    }

    function parseMoney(valStr) {
        if (!valStr || typeof valStr !== 'string') return 0;
        if (valStr.includes('NaN')) return 0;
        let clean = valStr.replace(/[^\d,]/g, '').replace(',', '.');
        let val = parseFloat(clean);
        return isNaN(val) ? 0 : val;
    }

    function formatCurrency(val) {
        if (isNaN(val)) val = 0;
        return val.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    }

</script>

</body>
</html>
